var connect = require('connect')
var serveStatic = require('serve-static')
var vhost = require('vhost')
 
var mainapp = connect()
 
// add middlewares to mainapp for the main web site 
 
// create app that will server user content from public/{username}/ 
var userapp = connect()
 
userapp.use(function(req, res, next){
  var username = req.vhost[0] // username is the "*" 
 
  // pretend request was for /{username}/* for file serving 
  req.originalUrl = req.url
  req.url = '/' + username + req.url
 
  next()
})
userapp.use(serveStatic('public'))
 
// create main app 
var app = connect()
 
// add vhost routing for main app 
app.use(vhost('userpages.local', mainapp))
app.use(vhost('www.userpages.local', mainapp))
 
// listen on all subdomains for user pages 
app.use(vhost('*.userpages.local', userapp))
 
app.listen(3000)